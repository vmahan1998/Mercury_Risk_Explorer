rm(list = ls(all = TRUE))
library(dplyr)
library(ggplot2)
library(scales)
library(grid)   # unit()
# ----------------------------
# Paths
# ----------------------------
path.input <- "/Users/RDEL1VMM/Desktop/current projects/Penobscot_Habitat_Model/outputs/"
analysis_dir <- file.path(path.input, "analysis_summary")
output_dir <- file.path(analysis_dir, "report_figures")
dir.create(analysis_dir, showWarnings = FALSE, recursive = TRUE)
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)
cat("Analysis dir:", analysis_dir, "\n")
cat("Output dir:", output_dir, "\n")
# ----------------------------
# Load list
# ----------------------------
#all_list <- readRDS(file.path(path.input, "all_patch_data.rds"))
all_patch_data <- readRDS(file.path(path.input, "all_patch_data.rds"))
# Build one long table so you can compute global thresholds cleanly
all_df <- bind_rows(all_patch_data)
if (!"patch_area" %in% names(all_df)) all_df$patch_area <- 38582.666699086
library(dplyr)
library(ggplot2)
library(scales)
library(ggridges)
# Base theme for consistency
base_theme <- theme_ridges() +
theme(
plot.title   = element_text(size = 12),
axis.text.x  = element_text(size = 12),
axis.text.y  = element_text(size = 12),
axis.title.x = element_text(size = 12),
axis.title.y = element_text(size = 12),
legend.text  = element_text(size = 12),
legend.title = element_text(size = 12)
)
impact_risk_mehg <- all_df %>%
mutate(
Month = factor(Month, levels = month_levels),
LifeStage = factor(LifeStage, levels = life_stage_levels)
) %>%
select(Month, LifeStage, Impact_MeHg) %>%
rename(Impact_Risk = Impact_MeHg) %>%
filter(
!is.na(Impact_Risk),
is.finite(Impact_Risk),
Impact_Risk > 0
)
month_levels <- c("Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct")
life_stage_levels <- c("adult", "egg_larvae", "nonmigratory_juvenile")
life_stage_labels <- c(
"adult" = "Adult",
"egg_larvae" = "Egg and Larvae",
"nonmigratory_juvenile" = "Non-Migratory Juvenile"
)
lifestage_colors <- c(
"adult"                 = "#d73027",
"egg_larvae"            = "#fee08b",
"nonmigratory_juvenile" = "#91cf60"
)
library(dplyr)
library(ggplot2)
library(scales)
library(ggridges)
# Base theme for consistency
base_theme <- theme_ridges() +
theme(
plot.title   = element_text(size = 12),
axis.text.x  = element_text(size = 12),
axis.text.y  = element_text(size = 12),
axis.title.x = element_text(size = 12),
axis.title.y = element_text(size = 12),
legend.text  = element_text(size = 12),
legend.title = element_text(size = 12)
)
impact_risk_mehg <- all_df %>%
mutate(
Month = factor(Month, levels = month_levels),
LifeStage = factor(LifeStage, levels = life_stage_levels)
) %>%
select(Month, LifeStage, Impact_MeHg) %>%
rename(Impact_Risk = Impact_MeHg) %>%
filter(
!is.na(Impact_Risk),
is.finite(Impact_Risk),
Impact_Risk > 0
)
impact_v <- ggplot(
impact_risk_mehg,
aes(x = Month, y = Impact_Risk, fill = LifeStage)
) +
geom_violin(
trim = FALSE,
width = 1.05,
alpha = 0.75,
color = "black",
linewidth = 0.3,
position = position_dodge(width = 0.9)
) +
stat_summary(
fun.min = min,
fun.max = max,
geom = "errorbar",
width = 0.7,
linewidth = 0.5,
color = "black",
position = position_dodge(width = 0.9)
) +
stat_summary(
fun = median,
geom = "crossbar",
width = 0.5,
fatten = 0,
linewidth = 0.9,
color = "black",
position = position_dodge(width = 0.9)
) +
scale_fill_manual(
values = lifestage_colors,
breaks = life_stage_levels,
labels = life_stage_labels,
name = "Life Stage"
) +
scale_y_continuous(labels = label_number(accuracy = 0.01)) +
labs(
title = "Distribution of MeHg impact risk by month and life stage",
x = NULL,
y = "Impact Factor (MeHg)"
) +
base_theme +
theme(
text = element_text(size = 24),
plot.title = element_text(size = 26, face = "bold"),
plot.subtitle = element_text(size = 24),
axis.text.x = element_text(size = 24),
axis.text.y = element_text(size = 24),
axis.title.y = element_text(size = 24),
legend.position = "top",
legend.title = element_text(size = 24),
legend.text = element_text(size = 24),
strip.text = element_text(size = 24)
)
readr::write_csv(
impact_risk_mehg,
file.path(output_dir, "impact_risk_mehg_violin_input.csv")
)
ggsave(
filename = file.path(output_dir, "Figure_Impact_Time_Violin_MeHg_MinMax.png"),
plot     = impact_v,
width    = 14,
height   = 8,
dpi      = 300
)
impact_v
rm(impact_v)
rm(base_theme)
rm(impact_risk_mehg)
library(dplyr)
library(ggplot2)
library(scales)
impairment_df <- all_df %>%
mutate(
Month = factor(Month, levels = month_levels),
LifeStage = factor(LifeStage, levels = life_stage_levels),
Impairment_Total = pmax(HabImpair_THg, HabImpair_MeHg, na.rm = TRUE)
) %>%
select(Month, LifeStage, Impairment_Total) %>%
filter(
!is.na(Impairment_Total),
is.finite(Impairment_Total),
Impairment_Total > 0
)
impair_v <- ggplot(
impairment_df,
aes(x = Month, y = Impairment_Total, fill = LifeStage)
) +
geom_violin(
trim = FALSE,
width = 1.05,
alpha = 0.75,
color = "black",
linewidth = 0.3,
position = position_dodge(width = 0.9)
) +
stat_summary(
fun.min = min,
fun.max = max,
geom = "errorbar",
width = 0.7,
linewidth = 0.5,
color = "black",
position = position_dodge(width = 0.9)
) +
stat_summary(
fun = median,
geom = "crossbar",
width = 0.7,
fatten = 0,
linewidth = 0.9,
color = "black",
position = position_dodge(width = 0.9)
) +
scale_fill_manual(
values = lifestage_colors,
breaks = life_stage_levels,
labels = life_stage_labels,
name = "Life Stage"
) +
scale_y_continuous(labels = label_number(accuracy = 0.01)) +
labs(
title = "Distribution of habitat impairment by month and life stage",
x = NULL,
y = "Habitat Impairment Factor"
) +
base_theme +
theme(
text = element_text(size = 24),
plot.title = element_text(size = 26, face = "bold"),
plot.subtitle = element_text(size = 24),
axis.text.x = element_text(size = 24),
axis.text.y = element_text(size = 24),
axis.title.y = element_text(size = 24),
legend.position = "top",
legend.title = element_text(size = 24),
legend.text = element_text(size = 24),
strip.text = element_text(size = 24)
)
# Base theme for consistency
base_theme <- theme_ridges() +
theme(
plot.title   = element_text(size = 12),
axis.text.x  = element_text(size = 12),
axis.text.y  = element_text(size = 12),
axis.title.x = element_text(size = 12),
axis.title.y = element_text(size = 12),
legend.text  = element_text(size = 12),
legend.title = element_text(size = 12)
)
library(dplyr)
library(ggplot2)
library(scales)
impairment_df <- all_df %>%
mutate(
Month = factor(Month, levels = month_levels),
LifeStage = factor(LifeStage, levels = life_stage_levels),
Impairment_Total = pmax(HabImpair_THg, HabImpair_MeHg, na.rm = TRUE)
) %>%
select(Month, LifeStage, Impairment_Total) %>%
filter(
!is.na(Impairment_Total),
is.finite(Impairment_Total),
Impairment_Total > 0
)
impair_v <- ggplot(
impairment_df,
aes(x = Month, y = Impairment_Total, fill = LifeStage)
) +
geom_violin(
trim = FALSE,
width = 1.05,
alpha = 0.75,
color = "black",
linewidth = 0.3,
position = position_dodge(width = 0.9)
) +
stat_summary(
fun.min = min,
fun.max = max,
geom = "errorbar",
width = 0.7,
linewidth = 0.5,
color = "black",
position = position_dodge(width = 0.9)
) +
stat_summary(
fun = median,
geom = "crossbar",
width = 0.7,
fatten = 0,
linewidth = 0.9,
color = "black",
position = position_dodge(width = 0.9)
) +
scale_fill_manual(
values = lifestage_colors,
breaks = life_stage_levels,
labels = life_stage_labels,
name = "Life Stage"
) +
scale_y_continuous(labels = label_number(accuracy = 0.01)) +
labs(
title = "Distribution of habitat impairment by month and life stage",
x = NULL,
y = "Habitat Impairment Factor"
) +
base_theme +
theme(
text = element_text(size = 24),
plot.title = element_text(size = 26, face = "bold"),
plot.subtitle = element_text(size = 24),
axis.text.x = element_text(size = 24),
axis.text.y = element_text(size = 24),
axis.title.y = element_text(size = 24),
legend.position = "top",
legend.title = element_text(size = 24),
legend.text = element_text(size = 24),
strip.text = element_text(size = 24)
)
readr::write_csv(
impairment_df,
file.path(output_dir, "impairment_total_violin_input.csv")
)
ggsave(
filename = file.path(output_dir, "Figure_Impairment_Time_Violin_MinMax.png"),
plot     = impair_v,
width    = 14,
height   = 8,
dpi      = 400
)
impair_v
rm(impairment_df)
rm(impair_v)
# Life-stage order and labels
life_stage_levels <- c("adult","egg_larvae","nonmigratory_juvenile")
life_stage_labels <- c(
adult = "Adult",
egg_larvae = "Egg and Larvae",
nonmigratory_juvenile = "Non-Migratory Juvenile"
)
# -------------------------------
# 1) Monthly HQ-filtered sums
# -------------------------------
monthly_hq <- all_df %>%
mutate(
Month = factor(Month, levels = month_levels),
LifeStage = factor(LifeStage, levels = life_stage_levels),
# pick what you mean by "impact" and "impairment"
Impact_Total = Impact_MeHg * patch_area,
Impair_Total = HabImpair_MeHg * patch_area
) %>%
filter(
mean_hsi >= 0.8,
!is.na(Impact_Total), is.finite(Impact_Total),
!is.na(Impair_Total), is.finite(Impair_Total)
) %>%
group_by(Month, LifeStage) %>%
summarise(
MonthlyImpact = sum(Impact_Total, na.rm = TRUE),
MonthlyImpair = sum(Impair_Total, na.rm = TRUE),
.groups = "drop"
)
# -------------------------------
# 2) Seasonal cumulative totals
# -------------------------------
seasonal_cum_long <- monthly_hq %>%
group_by(LifeStage) %>%
summarise(
`Exposure Intensity` = sum(MonthlyImpact, na.rm = TRUE),
`Impaired Habitat` = sum(MonthlyImpair, na.rm = TRUE),
.groups = "drop"
) %>%
tidyr::pivot_longer(
cols = c(`Exposure Intensity`, `Impaired Habitat`),
names_to = "Metric",
values_to = "CumulativeValue"
) %>%
mutate(
Metric = factor(Metric, levels = c("Exposure Intensity", "Impaired Habitat")),
LifeStage = factor(LifeStage, levels = life_stage_levels)
)
# -------------------------------
# 3) Plot: 2 groups, 3 bars each
# -------------------------------
fig_cum_summary <- ggplot(
seasonal_cum_long,
aes(x = Metric, y = CumulativeValue, fill = LifeStage)
) +
geom_col(
position = position_dodge2(width = 0.82, preserve = "single"),
width = 0.42,
color = "black",
linewidth = 0.3
) +
scale_fill_manual(
values = lifestage_colors,
breaks = life_stage_levels,
labels = life_stage_labels,
name = NULL
) +
scale_y_continuous(
labels = label_comma(),
expand = expansion(mult = c(0, 0.06))
) +
labs(
title = " ",
subtitle = " ",
x = NULL,
y = expression(
"Cumulative MeHg Risk (area-weighted " *
m^2 * ")"
)
) +
theme(
plot.title = element_text(face = "bold", size = 18, margin = margin(b = 4)),
plot.subtitle = element_text(size = 16, margin = margin(b = 10)),
axis.text.x  = element_text(size = 16, color = "black"),
axis.text.y  = element_text(size = 16, color = "black"),
axis.title.y = element_text(size = 16, color = "black", margin = margin(r = 10)),
legend.position = "bottom",
legend.direction = "horizontal",
legend.justification = "center",
legend.text = element_text(size = 16),
legend.key.size = unit(0.9, "lines"),
legend.margin = margin(t = 8),
panel.background = element_rect(fill = "white", color = NA),
plot.background  = element_rect(fill = "white", color = NA),
panel.grid.minor = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.major.y = element_line(color = "grey85", linewidth = 0.35),
plot.margin = margin(12, 14, 12, 14)
)
readr::write_csv(
seasonal_cum_long,
file.path(output_dir, "seasonal_cumulative_long_hsi08.csv")
)
shiny::runApp()
runApp()
shiny::runApp()
